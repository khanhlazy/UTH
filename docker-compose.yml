services:
  mongodb:
    image: mongo:7.0
    container_name: furnimart-mongodb
    restart: unless-stopped
    ports:
      - '27017:27017'
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: furnimart
    volumes:
      - mongodb_data:/data/db
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'mongosh', '--quiet', '--eval', 'db.adminCommand("ping")', '-u', 'admin', '-p', 'admin123', '--authenticationDatabase', 'admin']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # API Gateway - Entry point for all microservices
  api-gateway:
    build:
      context: .
      dockerfile: ./api-gateway/Dockerfile
    container_name: furnimart-api-gateway
    restart: unless-stopped
    ports:
      - '3001:3001'
    environment:
      PORT: 3001
      NODE_ENV: ${NODE_ENV:-production}
      # Microservice URLs
      AUTH_SERVICE_URL: http://auth-service:3002
      USER_SERVICE_URL: http://user-service:3003
      PRODUCT_SERVICE_URL: http://product-service:3004
      ORDER_SERVICE_URL: http://order-service:3005
      SHIPPING_SERVICE_URL: http://shipping-service:3006
      REVIEW_SERVICE_URL: http://review-service:3007
      CHAT_SERVICE_URL: http://chat-service:3008
      WAREHOUSE_SERVICE_URL: http://warehouse-service:3009
      DISPUTE_SERVICE_URL: http://dispute-service:3010
      SETTINGS_SERVICE_URL: http://settings-service:3011
      UPLOAD_SERVICE_URL: http://upload-service:3012
      CATEGORY_SERVICE_URL: http://category-service:3013
      DASHBOARD_SERVICE_URL: http://dashboard-service:3014
      PAYMENT_SERVICE_URL: http://payment-service:3015
      PROMOTION_SERVICE_URL: http://promotion-service:3016
      BRANCH_SERVICE_URL: http://branch-service:3017
      WALLET_SERVICE_URL: http://wallet-service:3018
      CART_SERVICE_URL: http://cart-service:3019
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:3001}
    depends_on:
      auth-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
      product-service:
        condition: service_healthy
      order-service:
        condition: service_healthy
      shipping-service:
        condition: service_healthy
      review-service:
        condition: service_healthy
      chat-service:
        condition: service_healthy
      warehouse-service:
        condition: service_healthy
      dispute-service:
        condition: service_healthy
      settings-service:
        condition: service_healthy
      upload-service:
        condition: service_healthy
      category-service:
        condition: service_healthy
      dashboard-service:
        condition: service_healthy
      payment-service:
        condition: service_healthy
      promotion-service:
        condition: service_healthy
      branch-service:
        condition: service_healthy
      wallet-service:
        condition: service_healthy
      cart-service:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3001/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  auth-service:
    build:
      context: .
      dockerfile: ./services/auth-service/Dockerfile
    container_name: furnimart-auth-service
    restart: unless-stopped
    ports:
      - '3002:3002'
    environment:
      PORT: 3002
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3002/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  user-service:
    build:
      context: .
      dockerfile: ./services/user-service/Dockerfile
    container_name: furnimart-user-service
    restart: unless-stopped
    ports:
      - '3003:3003'
    environment:
      PORT: 3003
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3003/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  product-service:
    build:
      context: .
      dockerfile: ./services/product-service/Dockerfile
    container_name: furnimart-product-service
    restart: unless-stopped
    ports:
      - '3004:3004'
    environment:
      PORT: 3004
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3004/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  order-service:
    build:
      context: .
      dockerfile: ./services/order-service/Dockerfile
    container_name: furnimart-order-service
    restart: unless-stopped
    ports:
      - '3005:3005'
    environment:
      PORT: 3005
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
      BRANCH_SERVICE_URL: http://branch-service:3017
      PRODUCT_SERVICE_URL: http://product-service:3004
      USER_SERVICE_URL: http://user-service:3003
      WAREHOUSE_SERVICE_URL: http://warehouse-service:3009
      INTERNAL_SERVICE_SECRET: ${INTERNAL_SERVICE_SECRET:-furnimart-internal-secret-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3005/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  shipping-service:
    build:
      context: .
      dockerfile: ./services/shipping-service/Dockerfile
    container_name: furnimart-shipping-service
    restart: unless-stopped
    ports:
      - '3006:3006'
    environment:
      PORT: 3006
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3006/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  review-service:
    build:
      context: .
      dockerfile: ./services/review-service/Dockerfile
    container_name: furnimart-review-service
    restart: unless-stopped
    ports:
      - '3007:3007'
    environment:
      PORT: 3007
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3007/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  chat-service:
    build:
      context: .
      dockerfile: ./services/chat-service/Dockerfile
    container_name: furnimart-chat-service
    restart: unless-stopped
    ports:
      - '3008:3008'
    environment:
      PORT: 3008
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3008/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  warehouse-service:
    build:
      context: .
      dockerfile: ./services/warehouse-service/Dockerfile
    container_name: furnimart-warehouse-service
    restart: unless-stopped
    ports:
      - '3009:3009'
    environment:
      PORT: 3009
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3009/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  dispute-service:
    build:
      context: .
      dockerfile: ./services/dispute-service/Dockerfile
    container_name: furnimart-dispute-service
    restart: unless-stopped
    ports:
      - '3010:3010'
    environment:
      PORT: 3010
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3010/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  settings-service:
    build:
      context: .
      dockerfile: ./services/settings-service/Dockerfile
    container_name: furnimart-settings-service
    restart: unless-stopped
    ports:
      - '3011:3011'
    environment:
      PORT: 3011
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3011/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  upload-service:
    build:
      context: .
      dockerfile: ./services/upload-service/Dockerfile
    container_name: furnimart-upload-service
    restart: unless-stopped
    ports:
      - '3012:3012'
    environment:
      PORT: 3012
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    volumes:
      - images_data:/app/images
      - uploads_data:/app/uploads  # Keep for backward compatibility
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3012/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  category-service:
    build:
      context: .
      dockerfile: ./services/category-service/Dockerfile
    container_name: furnimart-category-service
    restart: unless-stopped
    ports:
      - '3013:3013'
    environment:
      PORT: 3013
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3013/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  dashboard-service:
    build:
      context: .
      dockerfile: ./services/dashboard-service/Dockerfile
    container_name: furnimart-dashboard-service
    restart: unless-stopped
    ports:
      - '3014:3014'
    environment:
      PORT: 3014
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3014/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  payment-service:
    build:
      context: .
      dockerfile: ./services/payment-service/Dockerfile
    container_name: furnimart-payment-service
    restart: unless-stopped
    ports:
      - '3015:3015'
    environment:
      PORT: 3015
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
      # VNPAY Configuration
      VNP_TMN_CODE: ${VNP_TMN_CODE:-7MFQRM1G}
      VNP_HASH_SECRET: ${VNP_HASH_SECRET:-HUOUL72ZW06UZRY5ZG6D8QARXPQ1ZDDR}
      VNP_URL: ${VNP_URL:-https://sandbox.vnpayment.vn/paymentv2/vpcpay.html}
      VNP_RETURN_URL: ${VNP_RETURN_URL:-http://localhost:3000/payment/return}
      VNP_IPN_URL: ${VNP_IPN_URL:-}
      VNP_PUBLIC_IP: ${VNP_PUBLIC_IP:-14.243.185.38}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      API_GATEWAY_URL: ${API_GATEWAY_URL:-http://api-gateway:3001}
      ORDER_SERVICE_URL: ${ORDER_SERVICE_URL:-http://order-service:3005}
      INTERNAL_SERVICE_SECRET: ${INTERNAL_SERVICE_SECRET:-furnimart-internal-secret-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3015/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  promotion-service:
    build:
      context: .
      dockerfile: ./services/promotion-service/Dockerfile
    container_name: furnimart-promotion-service
    restart: unless-stopped
    ports:
      - '3016:3016'
    environment:
      PORT: 3016
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3016/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  branch-service:
    build:
      context: .
      dockerfile: ./services/branch-service/Dockerfile
    container_name: furnimart-branch-service
    restart: unless-stopped
    ports:
      - '3017:3017'
    environment:
      PORT: 3017
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3017/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  wallet-service:
    build:
      context: .
      dockerfile: ./services/wallet-service/Dockerfile
    container_name: furnimart-wallet-service
    restart: unless-stopped
    ports:
      - '3018:3018'
    environment:
      PORT: 3018
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
      # VNPAY Configuration
      VNP_TMN_CODE: ${VNP_TMN_CODE:-7MFQRM1G}
      VNP_HASH_SECRET: ${VNP_HASH_SECRET:-HUOUL72ZW06UZRY5ZG6D8QARXPQ1ZDDR}
      VNP_URL: ${VNP_URL:-https://sandbox.vnpayment.vn/paymentv2/vpcpay.html}
      VNP_RETURN_URL: ${VNP_RETURN_URL_WALLET:-${VNP_RETURN_URL:-http://localhost:3000/wallet/deposit/return}}
      VNP_IPN_URL: ${VNP_IPN_URL_WALLET:-${VNP_IPN_URL:-}}
      VNP_PUBLIC_IP: ${VNP_PUBLIC_IP:-14.243.185.38}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      API_GATEWAY_URL: ${API_GATEWAY_URL:-http://api-gateway:3001}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3018/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  cart-service:
    build:
      context: .
      dockerfile: ./services/cart-service/Dockerfile
    container_name: furnimart-cart-service
    restart: unless-stopped
    ports:
      - '3019:3019'
    environment:
      PORT: 3019
      NODE_ENV: ${NODE_ENV:-production}
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/furnimart?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-furnimart-secret-key-2024}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3019/api/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Build-time: NEXT_PUBLIC_* vars are embedded in the build
        # For local dev: http://localhost:3001/api (browser accesses host)
        # For Docker network: http://api-gateway:3001/api (only if frontend runs in Docker)
        # NOTE: Browser makes requests, so use host-accessible URL
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3001/api}
    container_name: furnimart-frontend
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      # Runtime: NEXT_PUBLIC_* vars are already baked into build
      # This is only for reference - actual value comes from build args
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3001/api}
    volumes:
      # Mount images volume to public/images for Next.js to serve static files
      - images_data:/app/public/images
    depends_on:
      api-gateway:
        condition: service_healthy
    networks:
      - furnimart-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3000', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  mongodb_data:
  uploads_data:
  images_data:

networks:
  furnimart-network:
    driver: bridge
